# Разработка в репозитории

## Обзор репозитория
```
├── .dvc                     Конфигурация DVC
├── data                     Данные и иные артефакты ML
├── docs                     Документация
├── reports                  Отчёты, графики и метрики
├── model                    Файлы обученной модели
├── notebooks                Интерактивные скрипты Jupyter
├── scripts                  Скрипты для регулярных задач
├── tests                    Тесты проекта
├── yoric                    Основной код Python-пакета
├── .dvcignore               Файл исключений DVC
├── .flake8                  Конфигурация линтера Flake8
├── .gitignore               Файл исключений Git
├── .pre-commit-config.yaml  Конфигурация автопроверок при commit и push
├── .pylintrc                Конфигурация линтера Pylint
├── Makefile                 Конфигурация GNU Make для быстрых команд
├── dvc.lock                 Сохраненное состояние пайплайна DVC
├── dvc.yaml                 Конфигурация пайплайна DVC
├── params.yaml              Конфигурация гиперпараметров для пайплайна DVC
├── pyproject.toml           Прочие настройки Python-проекта
├── readme-en.md             Описание проекта EN (TODO)
├── readme-ru.md             Описание проекта RU
├── requirements.txt         Python-зависимости проекта
└── setup.py                 Скрипт сборки Python-пакета
```

### Используемые инструменты
- Хранение артефактов и метрик: DVC
- Качество кода: Mypy, Pylint, Flake8
- Форматирование: Black, iSort, Unify, Pyupgrade
- Прототипирование: Jupyter Notebook
- Прочее: Pre-commit, GNU Make

### Быстрые команды
Для удобства разработки регулярные команды вынесены в [Makefile](../Makefile) ([GNU Make](https://www.gnu.org/software/make/)). Утилита Make, как правило предостановлена на дистрибутивах Linux, но, если необходимо, её можно установить:
```shell
sudo apt install make -y
```
С помощью Make рекомендуется делать локальные проверки перед коммитами и форматировать код.
Подробнее о доступных командах можно посмотреть в справке (выполняя из корня проекта):
```shell
make help  # или просто make
```
При разработке на Windows (без WSL) эти команды работать не будут и их нужно будет запускать вручную, копируя из Makefile.

*В целом текущая версия репозитория не расчитана под разработку на Windows.*

### Автоматические проверки
В репозиториии настроены pre-commit хуки на действия `commit`, `push` и `checkout`. В нашем случае хуки проверяют:
- [согласованность версий файлов](https://dvc.org/doc/command-reference/install#install) в удаленном хранилище, кеше DVC и самом репозитории
- отсутствие ошибок в используемых типах
- отсутствие логических и стилевых ошибок
- прохождение тестов
- отсутствие больших файлов в коммитах и прочие мелкие проверки

И дополнительно:
- автоформатируют код, чтобы он был консистентен и единообразен
- очищают файлы кешей, сборки, мусор, оставленные при работе инструментов

Основные шаги pre-commit переиспользуют соответствующие команды Make.

## Создание окружения

_В проекте предполагается использование версии Python >=3.9!_
1. Создать виртуальное окружение Python с помощью Make:
    ```shell
    make venv
    ```
    Или вручную:
    ```shell
    python -m venv venv && \
    source /venv/bin/activate && \
    pip install --upgrade setuptools wheel pip && \
    pip install -e . && \
    pre-commit install
    ```

1. Выгрузить данные из DVC.

    _Команды выполняются из корня проекта! Если по какой-то причине DVC не подхватывает корень, достаточно установить переменную окружения `PYTHONPATH=$(pwd)`._

    Посмотреть каких данных не хватает:
    ```shell
    dvc status
    ```
    Выгрузить недостающие данные или все:
    ```shell
    dvc pull -R data
    ```

## Данные для обучения и тестирования

Данные взяты из русской Википедии с помощью библиотеки [corus](https://github.com/natasha/corus). Хранение и версионирование реализовано с помощью [DVC](https://dvc.org):
- Скрипты для получения данных находятся в директории [scripts](../scripts/)
- Пайплайн вызова соответствующих скриптов доступен в [dvc.yaml](../dvc.yaml)
- Параметры для вызова скриптов подставляются DVC из файла [params.yaml](../params.yaml) автоматически
- Датасет можно пересобрать заново при необходимости (или изменении параметров):

    ```shell
    dvc repro
    ```

    _Подробнее о работе с пайплайнами DVC можно ознакомиться в [документации](https://dvc.org/doc/user-guide/pipelines#pipelines)._


## Общий процесс

1. Внести правки в репозитории или добавить [новый эксперимент](./experiments.md).
1. Добавить тесты в `tests` и проверить их работу:
    ```shell
    pytest [tests/path/to/concrete/test.py]
    ```
1. Проверить, что ваши правки не внесли регресс, запустив все тесты:
    ```shell
    make tests
    ```
1. Опционально, проверить себя до коммита: вручную запустить линтер, форматтер, статический анализ с помощью Make:
    ```shell
    make all  # [style|types|...] см. справку: make help
    ```
1. Сделать коммит и отправить в репозиторий
1. Оформить PR по завершению работ
